name: CI/CD Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  schedule:
    - cron: '0 2 * * 0'  # Weekly on Sunday at 2 AM

jobs:
  test:
    runs-on: ubuntu-latest
    name: PowerShell Tests
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v6
      
    - name: Setup PowerShell
      shell: pwsh
      run: |
        Write-Host "PowerShell version: $($PSVersionTable.PSVersion)"
        Write-Host "Repository structure validation"
        
    - name: Validate repository structure
      shell: pwsh
      run: |
        Write-Host "Validating repository structure..."
        $requiredFiles = @(
          "README.md",
          "LICENSE", 
          "CONTRIBUTING.md",
          "SECURITY.md",
          "CHANGELOG.md"
        )
        
        foreach ($file in $requiredFiles) {
          if (Test-Path $file) {
            Write-Host "‚úì $file exists"
          } else {
            Write-Error "‚úó $file is missing"
            exit 1
          }
        }
        
        Write-Host "All required files are present"
        
    - name: PowerShell script validation
      shell: pwsh
      run: |
        Write-Host "Validating PowerShell scripts..."
        $scriptFiles = Get-ChildItem -Path "scripts" -Filter "*.ps1" -Recurse
        $hasErrors = $false
        
        foreach ($script in $scriptFiles) {
          Write-Host "Validating: $($script.Name)"
          try {
            # Use AST parsing for better validation
            $scriptContent = Get-Content $script.FullName -Raw
            $tokens = $null
            $errors = $null
            $ast = [System.Management.Automation.Language.Parser]::ParseInput($scriptContent, [ref]$tokens, [ref]$errors)
            
            if ($errors.Count -eq 0) {
              Write-Host "‚úì $($script.Name) syntax is valid"
            } else {
              Write-Host "‚úó $($script.Name) has syntax errors:"
              $errors | ForEach-Object { Write-Host "  - $($_.Message)" }
              $hasErrors = $true
            }
          } catch {
            Write-Host "‚úó $($script.Name) validation failed: $($_.Exception.Message)"
            $hasErrors = $true
          }
        }
        
        if ($hasErrors) {
          Write-Error "PowerShell script validation failed"
          exit 1
        } else {
          Write-Host "All PowerShell scripts are valid"
        }

  security-scan:
    runs-on: ubuntu-latest
    name: Security Scan
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v6
      
    - name: Run security scan
      shell: bash
      run: |
        echo "Running security scan..."
        
        # Check for sensitive data patterns (excluding legitimate code patterns)
        sensitive_findings=$(grep -r -i "password\s*=\|secret\s*=\|key\s*=\|token\s*=" --include="*.ps1" --include="*.md" . | grep -v -i "example\|placeholder\|template\|sample\|test\|parameter\|cmdlet" | grep -v "README.md" || true)
        
        if [ -n "$sensitive_findings" ]; then
          echo "‚ö†Ô∏è Potential sensitive data found:"
          echo "$sensitive_findings"
          echo "Please review these findings to ensure no actual credentials are exposed."
        else
          echo "‚úì No sensitive data patterns detected"
        fi
        
        # Check for hardcoded credentials patterns
        hardcoded_creds=$(grep -r -E "(password|secret|key|token)\s*[:=]\s*['\"][^'\"]{8,}" --include="*.ps1" --include="*.md" . | grep -v -i "example\|placeholder\|template\|sample\|test" || true)
        
        if [ -n "$hardcoded_creds" ]; then
          echo "‚ùå Hardcoded credentials detected:"
          echo "$hardcoded_creds"
          exit 1
        else
          echo "‚úì No hardcoded credentials detected"
        fi
        
        echo "Security scan completed"

  documentation:
    runs-on: ubuntu-latest
    name: Documentation Check
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v6
      
    - name: Validate documentation
      shell: bash
      run: |
        echo "Validating documentation..."
        
        # Check README.md structure
        if grep -q "üìã Overview" README.md; then
          echo "‚úì README.md has proper structure"
        else
          echo "‚úó README.md missing required sections"
          exit 1
        fi
        
        # Check for required disclaimers
        if grep -q "Star this repository if you find it helpful" README.md; then
          echo "‚úì Star disclaimer present"
        else
          echo "‚úó Missing star disclaimer"
          exit 1
        fi
        
        if grep -q "Use of this code is at your own risk" README.md; then
          echo "‚úì Risk disclaimer present"
        else
          echo "‚úó Missing risk disclaimer"
          exit 1
        fi
        
        echo "Documentation validation completed"

  release-check:
    runs-on: ubuntu-latest
    name: Release Validation
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v6
      
    - name: Check for version updates
      shell: bash
      run: |
        echo "Checking for version updates..."
        
        if [ -f "CHANGELOG.md" ]; then
          echo "‚úì CHANGELOG.md exists"
          echo "Release validation completed"
        else
          echo "‚ö†Ô∏è CHANGELOG.md not found"
          echo "Release validation completed with warnings"
        fi